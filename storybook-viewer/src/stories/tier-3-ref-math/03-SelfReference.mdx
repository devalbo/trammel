import { Meta } from '@storybook/blocks';
import * as Stories from './03-SelfReference.stories';
import { LiveCanvas } from '../../components/LiveCanvas';

<Meta of={Stories} />

# 013 — Self-Reference

## Description

A rectangle whose height is derived from its own width, locking a 4:3 aspect ratio. Tests the `$self` prefix for intra-shape references.

## Elements

| Element | Type | Purpose |
|---------|------|---------|
| `<Rect>` #box | Primitive | Self-referencing rect |

## Constraints Used

| Constraint | Expression | Resolution |
|---|---|---|
| Self-reference | `height="$self.width * 0.75"` | width = 120 → 120 * 0.75 = 90 → height = 90 |

## Default

<LiveCanvas code={Stories.defaultCode} />

## Resolver Trace

1. box begins resolution with known values: `x = 30`, `y = 20`, `width = 120`
2. `height` encounters `$self.width` → reads own resolved width → 120
3. Applies `* 0.75` → 90
4. box resolves: `{ x: 30, y: 20, w: 120, h: 90 }`

## Expected SVG Output

```svg
<svg viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg">
  <rect x="30" y="20" width="120" height="90" fill="#4a90d9" stroke="#333" />
</svg>
```

## What This Validates

- `$self` prefix references the shape's own resolved properties
- Self-references resolve in a single pass when the referenced property is already known
- This is the simplest form of aspect ratio locking
